# Promo Code Manager

Fullstack –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –Ω–∞ –±–∞–∑–µ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (OLTP + OLAP).

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

Promo Code Manager ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é:
- –°–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∫ –∑–∞–∫–∞–∑–∞–º
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏
- –ü–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –æ—Ç—á—ë—Ç–æ–≤

## üìÑ –ó–∞–¥–∞–Ω–∏–µ

–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ: [documentation/task/TEST_TASK_PROMO_CODE_MANAGER_v2.1.md](./documentation/task/TEST_TASK_PROMO_CODE_MANAGER_v2.1.md)

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- Backend –Ω–∞ NestJS —Å MongoDB (OLTP) –∏ ClickHouse (OLAP)
- Frontend –Ω–∞ React/Next.js
- Event-Driven —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É MongoDB –∏ ClickHouse
- –ü–æ–ª–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤: [documentation/README.md](./documentation/README.md)

**–†–∞–∑–¥–µ–ª—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**
- [Database Setup](./documentation/database-setup.md) - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
- [ClickHouse Guide](./documentation/clickhouse-guide.md) - –†–∞–±–æ—Ç–∞ —Å ClickHouse
- [Event Bus & Queue System](./documentation/event-bus-queue-clickhouse.md) - Event-Driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [Mongoose Architecture](./documentation/mongoose-architecture.md) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å Mongoose
- [CHANGELOG](./documentation/CHANGELOG.md) - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**MongoDB (OLTP)** ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã:
- –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤, –∑–∞–∫–∞–∑–æ–≤
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å—é
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**ClickHouse (OLAP)** ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:
- –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** Event-Driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–µ—Ä–µ–∑ Redis/BullMQ

### 2. Event-Driven —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   MongoDB   ‚îÇ (OLTP - –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ –°–æ–∑–¥–∞–Ω–∏–µ/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   EventBus (Redis/Bull)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Consumers     ‚îÇ
‚îÇ   (Bull Queue)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ –ó–∞–ø–∏—Å—å –≤ ClickHouse
       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ClickHouse    ‚îÇ (OLAP - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å ‚Äî –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
- ‚úÖ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å ‚Äî retry –º–µ—Ö–∞–Ω–∏–∑–º —á–µ—Ä–µ–∑ Bull
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ consumers
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ ‚Äî OLTP –∏ OLAP –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã

### 3. Clean Architecture (Domain-Driven Design)

–ö–∞–∂–¥—ã–π –±–∏–∑–Ω–µ—Å-–º–æ–¥—É–ª—å —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º Clean Architecture:

```
module/
‚îú‚îÄ‚îÄ domain/              # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (—á–∏—Å—Ç–∞—è, –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
‚îÇ   ‚îú‚îÄ‚îÄ entity/          # Domain entities —Å –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ constants/       # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–æ–º–µ–Ω–∞
‚îÇ
‚îú‚îÄ‚îÄ application/         # Use Cases –∏ Application Services
‚îÇ   ‚îú‚îÄ‚îÄ services/       # Application services
‚îÇ   ‚îú‚îÄ‚îÄ use-cases/      # Use Cases (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏)
‚îÇ   ‚îî‚îÄ‚îÄ events/         # –î–æ–º–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
‚îÇ
‚îú‚îÄ‚îÄ infrastructure/      # –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ repositories/    # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (MongoDB)
‚îÇ   ‚îú‚îÄ‚îÄ schemas/        # Mongoose schemas
‚îÇ   ‚îî‚îÄ‚îÄ consumers/      # Event consumers (ClickHouse)
‚îÇ
‚îî‚îÄ‚îÄ api/                # API —Å–ª–æ–π
    ‚îú‚îÄ‚îÄ controllers/    # REST –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
    ‚îî‚îÄ‚îÄ dto/            # Data Transfer Objects
```

**Domain Entities** —Å–æ–¥–µ—Ä–∂–∞—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É:
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- –†–∞—Å—á—ë—Ç —Å–∫–∏–¥–æ–∫
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤

**Use Cases** –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã:
- –û—Ç–¥–µ–ª—è—é—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—é –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –£–ø—Ä–æ—â–∞—é—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –£–ª—É—á—à–∞—é—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞

### 4. JWT –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

**–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–≤:**
- **Access Token** (15 –º–∏–Ω—É—Ç) ‚Äî –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
- **Refresh Token** (7 –¥–Ω–µ–π) ‚Äî –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access token

**–ó–∞—â–∏—Ç–∞ —Ä–æ—É—Ç–æ–≤:**
- `@JwtAuth()` ‚Äî –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∑–∞—â–∏—Ç—ã —Ä–æ—É—Ç–æ–≤
- `@Public()` ‚Äî –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- `@CurrentUser()` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ClickHouse

**–†–µ—à–µ–Ω–∏–µ:** Init-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π:
1. –ñ–¥—ë—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ ClickHouse (healthcheck)
2. –°–æ–∑–¥–∞—ë—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö `analytics`
3. –ü—Ä–∏–º–µ–Ω—è–µ—Ç SQL-–º–∏–≥—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ Race Conditions –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å race condition:
- –î–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á–∏—Ç–∞—é—Ç –ø—Ä–æ–º–æ–∫–æ–¥ —Å `usedCount = 99` (–ª–∏–º–∏—Ç 100)
- –û–±–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é (`99 < 100`)
- –û–±–∞ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Å—á—ë—Ç—á–∏–∫ –¥–æ 100, —Ö–æ—Ç—è –ª–∏–º–∏—Ç –±—ã–ª –ø—Ä–µ–≤—ã—à–µ–Ω

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ MongoDB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. **MongoDB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è** –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
   ```typescript
   const session = await this.mongoService.startSession();
   return await session.withTransaction(async () => {
     // –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   });
   ```

2. **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞** —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–∞:
   ```typescript
   await this.promoCodeRepository.incrementUsageIfWithinLimit(
     promoCodeId,
     totalLimit,
     session
   );
   ```
   
   –ú–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `findOneAndUpdate` —Å —É—Å–ª–æ–≤–∏–µ–º:
   ```typescript
   this.promoCodeModel.findOneAndUpdate(
     {
       _id: promoCodeId,
       usedCount: { $lt: totalLimit } // –£—Å–ª–æ–≤–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ
     },
     { $inc: { usedCount: 1 } },
     { new: true, session }
   );
   ```

3. **–ï—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω**, –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è (–≤–µ—Ä–Ω—ë—Ç `null`), –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∏—Ç—Å—è.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å ‚Äî –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions ‚Äî MongoDB –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º —á–µ—Ä–µ–∑ `withTransaction`

**–ì–¥–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- `ApplyPromoCodeUseCase.execute()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MongoDB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `PromoCodeRepository.incrementUsageIfWithinLimit()` ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
- `BaseRepository` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ—Å—Å–∏–π –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
project/
‚îú‚îÄ‚îÄ backend/              # NestJS Backend API
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/      # –ë–∏–∑–Ω–µ—Å-–º–æ–¥—É–ª–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/    # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/   # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promo-codes/  # –ü—Ä–æ–º–æ–∫–æ–¥—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ orders/  # –ó–∞–∫–∞–∑—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics/    # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shared/  # –û–±—â–∏–µ –º–æ–¥—É–ª–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common/      # –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ clickhouse/      # ClickHouse –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml
‚îÇ
‚îú‚îÄ‚îÄ frontend/             # React Frontend (Vite)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/         # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã, —Ä–æ—É—Ç–∏–Ω–≥)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shared/      # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥—É–ª–∏ (API, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/   # –ë–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏ (–±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ features/   # –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (–±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ widgets/    # –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –±–ª–æ–∫–∏ UI (–±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pages/       # –°—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã)
‚îÇ   ‚îî‚îÄ‚îÄ public/         # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
‚îÇ
‚îî‚îÄ‚îÄ documentation/        # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
    ‚îú‚îÄ‚îÄ README.md        # –ì–ª–∞–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    ‚îú‚îÄ‚îÄ CHANGELOG.md    # –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    ‚îú‚îÄ‚îÄ database-setup.md
    ‚îú‚îÄ‚îÄ clickhouse-guide.md
    ‚îî‚îÄ‚îÄ event-bus-queue-clickhouse.md
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **Node.js** 18+
- **pnpm** (–∏–ª–∏ npm/yarn)
- **Docker** –∏ **Docker Compose**

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone <repository-url>
cd etolegko/project
```

### 2. –ó–∞–ø—É—Å–∫ Backend

```bash
cd backend

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pnpm install

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
cp env.example .env

# –ó–∞–ø—É—Å–∫ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (MongoDB, ClickHouse, Redis)
docker-compose up -d

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pnpm run start:dev
```

Backend –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:3000`
Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `http://localhost:3000/docs`

**–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [backend/README.md](./backend/README.md)

### 3. –ó–∞–ø—É—Å–∫ Frontend

```bash
cd frontend

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pnpm install

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pnpm run dev
```

Frontend –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:5173` (–∏–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç, –µ—Å–ª–∏ –∑–∞–Ω—è—Ç)

**–í–∞–∂–Ω–æ:** –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º frontend –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å backend (–¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ API –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ Orval)
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å `pnpm run generate:api` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ API –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ Swagger

**–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [frontend/README.md](./frontend/README.md)

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend
- **NestJS** ‚Äî Progressive Node.js framework
- **TypeScript** ‚Äî –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JavaScript
- **MongoDB** ‚Äî OLTP –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Mongoose ODM)
- **ClickHouse** ‚Äî OLAP –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- **Redis** ‚Äî –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—á–µ—Ä–µ–¥–∏ (BullMQ)
- **Passport.js** ‚Äî –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (JWT, Local)
- **Swagger** ‚Äî API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### Frontend
- **React 19** ‚Äî UI –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
- **TypeScript** ‚Äî –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JavaScript
- **Vite** ‚Äî –°–±–æ—Ä—â–∏–∫ –∏ dev-—Å–µ—Ä–≤–µ—Ä
- **Material-UI (MUI)** ‚Äî UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **TanStack Query (React Query)** ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å–µ—Ä–≤–µ—Ä–∞
- **React Router** ‚Äî –†–æ—É—Ç–∏–Ω–≥
- **Orval** ‚Äî –ö–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è API –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ Swagger
- **Material React Table** ‚Äî –¢–∞–±–ª–∏—Ü—ã —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- **Axios** ‚Äî HTTP –∫–ª–∏–µ–Ω—Ç

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- **Docker Compose** ‚Äî –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- **MongoDB** ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –ë–î
- **ClickHouse** ‚Äî –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ë–î
- **Redis** ‚Äî –ö—ç—à –∏ –æ—á–µ—Ä–µ–¥–∏

## üìä –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### Backend API

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏:**
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∫ –∑–∞–∫–∞–∑–∞–º

**–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:**
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º –∏ –ø—Ä–µ—Å–µ—Ç–∞–º

### Frontend

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Feature-Sliced Design (FSD)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (app, shared)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω API —Å–ª–æ–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º refresh token
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è API –∫–ª–∏–µ–Ω—Ç–æ–≤ (Orval)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (Theme, Query)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω —Ä–æ—É—Ç–∏–Ω–≥ (React Router)
- üîÑ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- üîÑ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏
- üîÑ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è: –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- üîÑ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Backend

```bash
cd backend

# –í—Å–µ —Ç–µ—Å—Ç—ã
pnpm run test

# –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞
pnpm run test:cov

# E2E —Ç–µ—Å—Ç—ã
pnpm run test:e2e
```

**–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:**
- ‚úÖ Users Module ‚Äî –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- ‚úÖ Auth Module ‚Äî 30 —Ç–µ—Å—Ç–æ–≤
- ‚úÖ Promo Codes Module ‚Äî 41 —Ç–µ—Å—Ç
- ‚úÖ Orders Module ‚Äî 40 —Ç–µ—Å—Ç–æ–≤
- ‚úÖ Analytics Module ‚Äî 24 —Ç–µ—Å—Ç–∞

## üìñ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–ó–∞–¥–∞–Ω–∏–µ](./documentation/task/TEST_TASK_PROMO_CODE_MANAGER_v2.1.md) ‚Äî –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞](./documentation/README.md) ‚Äî –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [Backend README](./backend/README.md) ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ backend
- [Frontend README](./frontend/README.md) ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ frontend
- [CHANGELOG](./documentation/CHANGELOG.md) ‚Äî –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.
